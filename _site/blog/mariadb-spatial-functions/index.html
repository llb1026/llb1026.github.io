<!DOCTYPE html>
<html lang="ko">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <title>JIYUN.ME | 내가 사용했던 MariaDB 공간함수</title>
    
        
    <!-- Post info -->
    <meta property="og:site_name" content="JIYUN.ME">
    <meta property="og:type" content="website" /> 
    <meta property="og:url" content="http://localhost:4000/blog/mariadb-spatial-functions/" />
    
    <meta property="og:image" content="http://localhost:4000/blog/mariadb-spatial-functions/img/01_1.png">

    <!-- title -->
    <meta property="og:title" content="JIYUN.ME | 내가 사용했던 MariaDB 공간함수">
    
    <!-- description -->
    <meta property="og:description" content="## 1. 구현 조건 카풀 서비스를 개발하면서 라이더(탑승자)가 출근 시 자신의 집과 가까운 카풀 탑승 장소를, 퇴근 시 자신의 집과 가까운 카풀 하차 장소를 찾는 기능을 구현하게 되었다. 라이더의 집..."/>
        
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/uikit.min.css">
    <link rel="stylesheet" href="/assets/css/uikit-width-ex.min.css">
    <link rel="stylesheet" href="/assets/css/ionicons.min.css">
    <link rel="stylesheet" href="/assets/css/owl.carousel.min.css">
    <link rel="stylesheet" href="/assets/css/font-awesome.css">
    <link rel="stylesheet" href="/assets/css/animations.css">
    <link rel="stylesheet" href="/assets/css/theme.css">
    <link rel="stylesheet" href="/assets/css/responsive.css">
    <link rel="stylesheet" href="/assets/css/toc.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/js/prettify/skins/github2.css">
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700%7CLora:400,400i%7CShadows+Into+Light:400" rel="stylesheet" />
    <link rel="shortcut icon" href="/assets/img/favicon_2.ico">
    

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-96635380-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-96635380-1');
    </script>

</head>

    
    <body class="loading">
        

        <!-- NavBar Start -->
        <div class="tw-preloader">
            <div data-uk-spinner></div>
        </div>

        <!-- 
        <div class="header-container tw-header uk-dark">
         -->
        <div class="header-container tw-header tw-header-transparent uk-dark" style="background-color: rgba(255, 255, 255, 0.25);">
        
            <nav class="uk-navbar-container uk-flex-center" data-uk-navbar>

                <!-- NavBar Left Logo Start -->
                <div class="uk-navbar-left">
                    <div class="tw-logo">
                        <h3 class="site-name">
                            <a href="/">JIYUN.ME</a>
                        </h3>
                    </div>
                </div>
                <!-- NavBar Left Logo End -->

                <!-- NavBar Center Menu Start -->
                <div class="uk-navbar-center" id="top">
                    <ul class="tw-main-menu uk-visible@m">
                        <li class="menu-item">
                            <a href="/"  class="normal"  class="active">Home</a>
                        </li>
                        <li class="menu-item">
                            <a href="/projects"  >Projects</a>
                        </li>
                        <li class="menu-item">
                            <a href="/blog"  class="active" >Blog</a>
                        </li>
                        <!-- <li class="menu-item">
                            <a href="/guestbook"  >Guestbook</a>
                        </li> -->
                    </ul>
                </div>
                <!-- NavBar Center Menu End -->

                <!-- NavBar Right Menu Icon Start -->
                <div class="uk-navbar-right">
                    <div class="tw-header-meta">
                        <a class="mobile-menu uk-navbar-toggle uk-hidden@m" href="#" data-uk-toggle="target: #mobile-menu-modal"><i class="ion-navicon-round"></i></a>
                    </div>
                </div>
                <!-- NavBar Right Menu Icon End -->

                <!-- NavBar Right Menu List Start -->
                <div id="mobile-menu-modal" class="uk-modal-full" data-uk-modal>
                    <div class="uk-modal-dialog">
                        <button class="uk-modal-close-full" type="button" data-uk-close></button>
                        <div class="uk-light uk-height-viewport tw-mobile-modal uk-flex uk-flex-middle uk-flex-center" data-uk-scrollspy="target:>ul>li,>div>a; cls:uk-animation-slide-bottom-medium; delay: 150;">
                            <ul class="uk-nav-default" data-uk-nav>
                                <li class="uk-nav-default">
                                    <a href="/"  class="normal"  class="active">Home</a>
                                </li>
                                <li class="uk-nav-default">
                                    <a href="/projects"  >Projects</a>
                                </li>
                                <li class="uk-nav-default">
                                    <a href="/blog"  class="active" >Blog</a>
                                </li>
                                <!-- <li class="uk-nav-default">
                                    <a href="/guestbook"  >Guestbook</a>
                                </li> -->
                            </ul>

                            <div class="tw-socials tw-socials-minimal">
                                <a href="https://github.com/llb1026" target="_blank"><i class="uk-icon-button tw-margin fa fa-github"></i></a>
                                <a href="https://www.linkedin.com/in/jiyun-lee-b19a02153" target="_blank"><i class="uk-icon-button tw-margin fa fa-linkedin"></i></a>
                            </div>

                        </div>
                    </div>
                </div>
                <!-- NavBar Right Menu List End -->

            </nav>
        </div>
        <!-- NavBar End -->
    
        <!-- Content Start -->
        <main>
            <div class="main-container">

    
        <br /><br />
<section class="uk-section-normal uk-section-blog" style="padding-bottom: 0;">
    <div class="uk-container uk-container-small">
        <div data-uk-grid>
            <div class="content-area uk-width-expand">
                <article class="single post">
                    <div class="entry-post">
                        <div class="entry-cats tw-meta">
                            <p>tech-notes</p>
                        </div>
                        <!-- <h2 class="entry-title post-title">
                            <a href="#">내가 사용했던 MariaDB 공간함수</a>
                        </h2> -->
                        <div class="heading-title-article post-title">
                            <h2 class="title">내가 사용했던 MariaDB 공간함수</h2>
                        </div>
                        <div class="entry-date tw-meta">
                            <span>나중에 보려고 정리한 공간함수들과 사용 예시들</span>
                        </div>

                        <!-- Blog Content Start -->
                        <div class="post-article">

                            <!-- Title Image Start -->
                            <div class="entry-media uk-padding-small">
                                <div class="tw-thumbnail" data-uk-lightbox>
                                    <img src="img/01_1.png" alt="" />
                                    <div class="image-overlay">
                                        <a href="img/01_1.png"></a>
                                    </div>
                                </div>
                            </div>
                            <!-- Title Image End -->

                            <!-- Scroll Spy TOC Start -->
                            <div class="toc">
                                <a href="#top">&#x1F446; 맨 위로</a>
                                <ul><li><a href="#1-구현-조건">1. 구현 조건</a></li><li><a href="#2-mbr_contains">2. MBR_Contains()</a></li><li><a href="#3-st_distance_sphere">3. ST_DISTANCE_SPHERE()</a></li><li><a href="#references">References</a></li></ul>
                            </div>
                            <!-- Scroll Spy TOC End -->

                            <h2 id="1-구현-조건">1. 구현 조건</h2>

<p>카풀 서비스를 개발하면서 라이더(탑승자)가 출근 시 자신의 집과 가까운 카풀 탑승 장소를, 퇴근 시 자신의 집과 가까운 카풀 하차 장소를 찾는 기능을 구현하게 되었다.</p>

<p>라이더의 집 주소, 회사 주소, 탑승 및 하차 가능한 모든 카풀 장소는 DB에 저장되어 있고, 앱에서 검색 필터로 반경 몇 미터 내의 카풀장소를 검색할 것인지에 대한 숫자값이 넘어온다고 했을 때 아래의 2가지 방법으로 접근해보기로 했다.</p>

<ol>
  <li>라이더의 좌표를 중심으로 반경 N 미터의 폴리곤을 그리고, 해당 폴리곤 범위 내에 속한 카풀 장소를 골라낸다</li>
  <li>각 카풀 장소와 라이더의 좌표 사이의 거리를 재고, 해당 거리가 N미터 이하인 카풀 장소를 골라낸다</li>
</ol>

<p>1번 방식을 <code class="language-plaintext highlighter-rouge">MBR_Contains()</code>로, 2번 방식을 <code class="language-plaintext highlighter-rouge">ST_DISTANCE_SPHERE()</code>로 구현해보았다.</p>

<hr />

<h2 id="2-mbr_contains">2. MBR_Contains()</h2>

<p><strong>MBR</strong><sup> Minimum Bounding Rectangle </sup>이란 ‘요소를 포함하는 가장 작은 사각형’이라는 뜻이다. MariaDB에서는 공간 검색 시 MBR들의 그룹을 더 큰 MBR이 묶고, 이런 그룹들을 또다시 더 큰 MBR로 묶는 R-Tree 구조의 인덱스를 사용한다.</p>

<p>R-Tree 인덱스를 사용하는 이유는 아래와 같다고 한다.</p>

<ul>
  <li>X좌표값, Y좌표값 2개 컬럼으로 B-Tree composite 인덱스를 걸면 Left-most 특성땜에 특정 영역 범위 검색 시 한 쪽밖에 인덱스를 타지 못 함 (데이터 분포에 따라 거의 풀 스캔을 해야 할 수 있음)</li>
  <li>위치 정보 검색 시 R-Tree 인덱스가 B-Tree와 비교해서 전반적으로 검색이 빠름 (단, 검색영역이 너무 넓으면 느림)</li>
</ul>

<p>아래 예시 코드에서 <code class="language-plaintext highlighter-rouge">wkt</code>는  Well Known Text의 약자로, 쉽게 이해할 수 있는 문자열로 데이터를 표현하는 방식이다. 예시로 <code class="language-plaintext highlighter-rouge">'POLYGON((175 150, 20 40, 50 60, 125 100, 175 150))'</code> 이런 식의 스트링 값이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"SELECT * FROM station "</span> <span class="o">+</span> 
    <span class="s">"WHERE MBR_Contains(ST_GeomFromText('"</span> <span class="o">+</span> <span class="s">":wkt"</span> <span class="o">+</span> <span class="s">"'), point)"</span><span class="o">,</span> 
    <span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">StationEntity</span><span class="o">&gt;</span> <span class="nf">findByAreaMbr</span><span class="o">(</span><span class="nc">String</span> <span class="n">wkt</span><span class="o">);</span>
</code></pre></div></div>

<hr />

<h2 id="3-st_distance_sphere">3. ST_DISTANCE_SPHERE()</h2>

<p><code class="language-plaintext highlighter-rouge">MBR_Contains()</code>로 몇 번 테스트를 돌려보았는데, 실행 속도가 그렇게 빠르다고 느껴지지 않았다. 이에 2번 방식을 시도했으나, 개발할 당시 프로젝트가 사용하고 있던 MariaDB 버전은 <code class="language-plaintext highlighter-rouge">ST_DISTANCE_SPHERE()</code>가 없었다 (10.2.38 버전부터 공식 지원한다고 한다 (<a href="https://mariadb.com/kb/en/st_distance_sphere/">링크</a>)).</p>

<p>따라서 직접 MySQL의 함수를 가져다 MariaDB에 만들어 사용했다.</p>

<p>정확히는 <code class="language-plaintext highlighter-rouge">MBR_Contains()</code>가 spatial index를 타고, <code class="language-plaintext highlighter-rouge">ST_DISTANCE_SPHERE()</code>는 풀스캔을 하기 때문에 함수 자체로만 놓고 보면 <code class="language-plaintext highlighter-rouge">MBR_Contains()</code>가 빠르게 처리되는 것이 맞다. 제대로 된 비교를 위해서는 나머지 소스들은 동일하게 가져가고 사용하는 함수만 갈아끼워 테스트 했어야 했는데, <code class="language-plaintext highlighter-rouge">MBR_Contains()</code>에서 <code class="language-plaintext highlighter-rouge">ST_DISTANCE_SPHERE()</code>로 변경하며 spatial index를 태운 범위필터링을 앞단에 한 번 추가로 거쳤고, 쿼리 전후의 Java단 로직이 변경되어 제대로 된 비교가 되지 않았다. 개발계의 테스트용 더미데이터가 적었던 것도 하나의 원인이었던 것 같다.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="nv">`st_distance_sphere`</span><span class="p">(</span><span class="nv">`pt1`</span> <span class="n">POINT</span><span class="p">,</span> <span class="nv">`pt2`</span> <span class="n">POINT</span><span class="p">)</span> <span class="k">RETURNS</span> <span class="nb">decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">BEGIN</span>
    <span class="k">return</span> <span class="mi">6371000</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ASIN</span><span class="p">(</span><span class="n">SQRT</span><span class="p">(</span>
       <span class="n">POWER</span><span class="p">(</span><span class="n">SIN</span><span class="p">((</span><span class="n">ST_Y</span><span class="p">(</span><span class="n">pt2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ST_Y</span><span class="p">(</span><span class="n">pt1</span><span class="p">))</span> <span class="o">*</span> <span class="n">pi</span><span class="p">()</span><span class="o">/</span><span class="mi">180</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
       <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">COS</span><span class="p">(</span><span class="n">ST_Y</span><span class="p">(</span><span class="n">pt1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pi</span><span class="p">()</span><span class="o">/</span><span class="mi">180</span> <span class="p">)</span> <span class="o">*</span> <span class="n">COS</span><span class="p">(</span><span class="n">ST_Y</span><span class="p">(</span><span class="n">pt2</span><span class="p">)</span> <span class="o">*</span>
       <span class="n">pi</span><span class="p">()</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">POWER</span><span class="p">(</span><span class="n">SIN</span><span class="p">((</span><span class="n">ST_X</span><span class="p">(</span><span class="n">pt2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ST_X</span><span class="p">(</span><span class="n">pt1</span><span class="p">))</span> <span class="o">*</span>
       <span class="n">pi</span><span class="p">()</span><span class="o">/</span><span class="mi">180</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="p">));</span>
    <span class="k">END</span>
</code></pre></div></div>

<p>참고로 <code class="language-plaintext highlighter-rouge">ST_DISTANCE()</code>는 평면 거리를 재는 함수이기 때문에, 우리가 살고 있는 구체의 지구에서 잰 거리와는 다른 값을 뱉는다.</p>

<p>사용 예시는 아래와 같다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"SELECT * from station "</span> <span class="o">+</span> 
    <span class="s">"WHERE ST_DISTANCE_SPHERE(ST_GeomFromText(CONCAT('Point(', :lon, ' ', :lat, ')')), point) &lt;= :range"</span><span class="o">,</span> 
    <span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">StationEntity</span><span class="o">&gt;</span> <span class="nf">findByAreaDistance</span><span class="o">(</span><span class="kt">double</span> <span class="n">range</span><span class="o">,</span> <span class="kt">double</span> <span class="n">lon</span><span class="o">,</span> <span class="kt">double</span> <span class="n">lat</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"SELECT *, ST_DISTANCE_SPHERE(Point(:lon, :lat), point) AS distance FROM station "</span> <span class="o">+</span> 
    <span class="s">"WHERE name = :#{#station.name()} "</span> <span class="o">+</span> 
    <span class="s">"HAVING distance &lt;= :range "</span> <span class="o">+</span> 
    <span class="s">"ORDER BY distance "</span> <span class="o">+</span> 
    <span class="s">"LIMIT 0, :limit"</span><span class="o">,</span> 
    <span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">StationEntity</span><span class="o">&gt;</span> <span class="nf">findByDistance</span><span class="o">(</span><span class="kt">double</span> <span class="n">range</span><span class="o">,</span> <span class="n">rouble</span> <span class="n">lon</span><span class="o">,</span> <span class="kt">double</span> <span class="n">lat</span><span class="o">,</span> <span class="nc">StationObject</span> <span class="n">station</span><span class="o">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="o">);</span>
</code></pre></div></div>

<hr />

<h2 id="references">References</h2>

<ul>
  <li><a href="https://jangjunha.github.io/blog/mysql-mariadb-spatial-index/">R-Tree 인덱스</a></li>
  <li><a href="https://stackoverflow.com/questions/44409012/function-st-distance-sphere-does-not-exist-in-mariadb">ST_DISTANCE_SPHERE 함수 생성 쿼리</a></li>
</ul>


                        </div>
                        <!-- Blog Content Start -->
                    </div>
                </article>
            </div>
        </div>
    </div>
</section>

<!-- Pagination Start -->
<section class="uk-section uk-section-small">
    <div class="uk-container uk-container-small">
        <div class="tw-portfolio-nav uk-flex uk-flex-between uk-flex-middle">
            
            <div class="nav-prev tw-meta">
                <a href="../spring-cloud-netflix/">
                    <i class="ion-ios-arrow-left"></i>
                    <span>Prev</span>
                </a>
            </div>
            
            <div class="nav-link">
                <a href="/blog">
                    <i class="ion-grid"></i>
                </a>
            </div>
            
            <div class="nav-next tw-meta">
                <a href="../mariadb-sql-mode-oracle/">
                    <span>Next</span>
                    <i class="ion-ios-arrow-right"></i>
                </a>
            </div>
            
        </div>
    </div>
</section>
<!-- Pagination End -->


<script>
    function getTOCNodes(master) {
        var nodes = Array.prototype.slice.call(master.getElementsByTagName("*"), 0);
        var tocNodes = nodes.filter(function(elem) {
            return elem.tagName == "A";
        });
        return tocNodes;
    }
    function getHeaderNodes(master) {
        var nodes = Array.prototype.slice.call(master.getElementsByTagName("*"), 0);
        var headerNodes = nodes.filter(function(elem) {
            return elem.tagName == "H1" || elem.tagName == "H2" || elem.tagName == "H3";
        });
        return headerNodes;
    }
  
    var title = document.getElementsByClassName("post-title")[0];
    var titleY = window.pageYOffset + title.getBoundingClientRect().top;
    
    var article = document.getElementsByClassName("post-article")[0];
    var articleY = window.pageYOffset + article.getBoundingClientRect().top;
  
    var toc = document.getElementsByClassName("toc")[0];
  
    var headerNodes = getHeaderNodes(article);
    var tocNodes = getTOCNodes(toc);
  
    var before = undefined;
  
    document.addEventListener('scroll', function(e) {
        if (window.scrollY >= articleY - 60) {
            toc.style.cssText = "position: fixed; top: 60px;";
        }
        else {
            toc.style.cssText = "";
        }
    
        var current = headerNodes.filter(function(header) {
            var headerY = window.pageYOffset + header.getBoundingClientRect().top;
            return window.scrollY >= headerY - 200;
        });
  
        if (current.length > 0) {
            current = current[current.length-1];
    
            var currentA = tocNodes.filter(function(tocNode) {
                return tocNode.innerHTML == current.innerHTML;
            })
            
            currentA = currentA[0];
            if (currentA) {
                if (before == undefined) before = currentA;
        
                if (before != currentA) {
                    before.classList.remove("toc-active");
                    before = currentA;
                }
        
                currentA.classList.add("toc-active");
            }
            else {
                if (before) 
                    before.classList.remove("toc-active");
            }
        }
        else {
            if (before) 
                before.classList.remove("toc-active");
        }
    }, false);
</script>

    
    
</div>


        </main>
        <!-- Content End -->
      
        <footer class="uk-section uk-padding-remove-vertical uk-light">
    <div class="footer-area footer-small">
        <div class="uk-container">
            <div class="uk-flex-middle uk-child-width-1-3" data-uk-grid>
                <div class="tw-element tw-socials tw-no-bg with-hover">
                    <a href="https://github.com/llb1026" target="_blank"><i class="uk-icon-button tw-margin fa fa-github"></i></a>
                    <a href="https://www.linkedin.com/in/jiyun-lee-b19a02153" target="_blank"><i class="uk-icon-button tw-margin fa fa-linkedin"></i></a>
                </div>
                <div class="uk-text-center copyright">
                    © JIYUN.ME
                </div>
                <div class="uk-text-right">
                    <a href="" data-uk-scroll>Top &nbsp;&nbsp;<i class="ion-ios-arrow-up"></i></a>
                </div>
            </div>
        </div>
    </div>
</footer>

   
        <script src="/assets/js/jquery-3.2.0.min.js"></script>
        <script src="/assets/js/jquery.easypiechart.min.js"></script>
        <script src="/assets/js/uikit.min.js"></script>
        <script src="/assets/js/uikit-icons.min.js"></script>
        <script src="/assets/js/isotope.pkgd.min.js"></script>
        <script src="/assets/js/owl.carousel.min.js"></script>
        <script src="/assets/js/theme.js"></script>
        

    </body>
</html>
